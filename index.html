<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulador de Breakeven de Energia</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { background:#111827; color:#f9fafb; font-family:sans-serif; margin:0; padding:20px; }
    h1 { font-size:1.5rem; margin-bottom:10px; }
    .container { display:grid; grid-template-columns:1fr 2fr; gap:20px; }
    .card { background:#1f2937; padding:15px; border-radius:10px; }
    label { font-size:0.9rem; display:block; margin-top:10px; }
    input { width:100%; padding:5px; border-radius:5px; border:none; background:#374151; color:white; }
    table { width:100%; border-collapse:collapse; font-size:0.9rem; }
    th, td { padding:6px; border-bottom:1px solid #374151; }
    th { color:#9ca3af; }
    .btn { background:#4f46e5; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .kpis { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px; }
    .kpi { background:#374151; padding:10px; border-radius:8px; text-align:center; }
    .kpi div:first-child { font-size:0.8rem; color:#9ca3af; }
    .kpi div:last-child { font-size:1.2rem; font-weight:bold; }
  </style>
</head>
<body>
  <h1>âš¡ Simulador de Breakeven de Energia</h1>
  <p style="color:#9ca3af;">Calcule o melhor momento para comprar energia antecipada com base em projeÃ§Ãµes e inflaÃ§Ã£o.</p>
  <button class="btn" onclick="gerarPDF()">ðŸ“„ Exportar PDF</button>

  <div class="container" id="simulador">
    <div class="card">
      <h2>Entradas</h2>
      <label>PreÃ§o ofertado (R$/kWh)</label>
      <input type="number" id="offeredPrice" value="0.55" step="0.001">
      <label>DuraÃ§Ã£o do contrato (meses)</label>
      <input type="number" id="contractMonths" value="12">
      <label>ProjeÃ§Ã£o de preÃ§o por ano (R$/kWh)</label>
      <div id="projYears"></div>
      <label>InflaÃ§Ã£o projetada por ano (decimal)</label>
      <div id="inflYears"></div>
      <label>Consumo mensal (kWh)</label>
      <div id="monthlyInputs"></div>
    </div>

    <div class="card">
      <h2>Resultados & KPIs</h2>
      <div class="kpis">
        <div class="kpi"><div>Consumo anual</div><div id="kpiConsumo">0</div></div>
        <div class="kpi"><div>Melhor mÃªs</div><div id="kpiMes">-</div></div>
        <div class="kpi"><div>Risco</div><div id="kpiRisco">-</div></div>
      </div>
      <canvas id="grafico" height="150"></canvas>
      <h3>Detalhes por mÃªs</h3>
      <div style="max-height:200px; overflow:auto;">
        <table>
          <thead><tr><th>MÃªs</th><th>Breakeven</th><th>Economia</th><th>kWh</th></tr></thead>
          <tbody id="tabela"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const meses=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
    let consumo=[800,760,720,700,680,650,640,660,700,750,780,820];
    let projPreco=[0.60,0.63,0.66,0.69,0.72];
    let inflacao=[0.05,0.045,0.04,0.04,0.035];
    let chart;

    function gerarInputs(){
      const projDiv=document.getElementById("projYears"); projDiv.innerHTML="";
      projPreco.forEach((v,i)=>{
        const inp=document.createElement("input");
        inp.type="number"; inp.value=v; inp.step="0.001";
        inp.oninput=()=>{projPreco[i]=parseFloat(inp.value)||0; calcular();};
        projDiv.appendChild(inp);
      });
      const inflDiv=document.getElementById("inflYears"); inflDiv.innerHTML="";
      inflacao.forEach((v,i)=>{
        const inp=document.createElement("input");
        inp.type="number"; inp.value=v; inp.step="0.001";
        inp.oninput=()=>{inflacao[i]=parseFloat(inp.value)||0; calcular();};
        inflDiv.appendChild(inp);
      });
      const mDiv=document.getElementById("monthlyInputs"); mDiv.innerHTML="";
      consumo.forEach((v,i)=>{
        const inp=document.createElement("input");
        inp.type="number"; inp.value=v;
        inp.oninput=()=>{consumo[i]=parseFloat(inp.value)||0; calcular();};
        mDiv.appendChild(inp);
      });
    }

    function precoMercado(mesesFut){
      const ano=Math.min(Math.floor(mesesFut/12),projPreco.length-1);
      let base=projPreco[ano]; let cumul=1;
      for(let y=0;y<=ano;y++) cumul*=(1+(inflacao[y]||0));
      return base*cumul;
    }

    function calcular(){
      const offered=parseFloat(document.getElementById("offeredPrice").value)||0;
      const mesesContrato=parseInt(document.getElementById("contractMonths").value)||12;
      let analises=[];
      for(let buy=0;buy<12;buy++){
        let totalBuy=0,totalNoBuy=0,totalKwh=0;
        for(let m=0;m<mesesContrato;m++){
          const idx=(buy+m)%12;
          const kwh=consumo[idx];
          const preco=precoMercado(m);
          totalBuy+=kwh*offered;
          totalNoBuy+=kwh*preco;
          totalKwh+=kwh;
        }
        const savings=totalNoBuy-totalBuy;
        const breakeven=totalKwh>0?totalNoBuy/totalKwh:0;
        analises.push({mes:meses[buy],savings,breakeven,totalKwh});
      }
      const totalConsumo=consumo.reduce((a,b)=>a+b,0);
      document.getElementById("kpiConsumo").innerText=totalConsumo;
      const melhor=analises.reduce((a,b)=>a.savings>b.savings?a:b);
      document.getElementById("kpiMes").innerText=melhor.mes;
      document.getElementById("kpiRisco").innerText=avaliarRisco();
      const tbody=document.getElementById("tabela"); tbody.innerHTML="";
      analises.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.mes}</td><td>${r.breakeven.toFixed(3)}</td>
                      <td style="color:${r.savings>=0?"#34d399":"#f87171"}">R$ ${r.savings.toFixed(2)}</td>
                      <td>${r.totalKwh}</td>`;
        tbody.appendChild(tr);
      });
      const ctx=document.getElementById("grafico").getContext("2d");
      if(chart) chart.destroy();
      chart=new Chart(ctx,{type:"line",
        data:{labels:analises.map(r=>r.mes),
              datasets:[
                {label:"Breakeven (R$/kWh)",data:analises.map(r=>r.breakeven),borderColor:"#60a5fa",fill:false},
                {label:"Economia (R$)",data:analises.map(r=>r.savings),borderColor:"#34d399",fill:false}
              ]},
        options:{responsive:true,plugins:{legend:{labels:{color:"white"}}},
                 scales:{x:{ticks:{color:"white"}},y:{ticks:{color:"white"}}}}
      });
    }

    function avaliarRisco(){
      function std(arr){const m=arr.reduce((a,b)=>a+b,0)/arr.length;return Math.sqrt(arr.reduce((s,v)=>s+(v-m)*(v-m),0)/arr.length);}
      const score=Math.round(std(projPreco)*100+std(inflacao)*200);
      if(score>60) return "Alto"; if(score>30) return "Moderado"; return "Baixo";
    }

    async function gerarPDF(){
      const el=document.getElementById("simulador");
      const canvas=await html2canvas(el,{scale:2});
      const img=canvas.toDataURL("image/png");
      const pdf=new jspdf.jsPDF("p","mm","a4");
      const w=pdf.internal.pageSize.getWidth();
      const h=pdf.internal.pageSize.getHeight();
      pdf.addImage(img,"PNG",0,0,w,h);
      pdf.save("simulador.pdf");
    }

    gerarInputs();
    calcular();
  </script>
</body>
</html>
